# Automated Release Workflow Design

**Date:** 2026-01-25
**Status:** Approved
**Version:** 1.0

## Overview

This document describes the fully automated release pipeline for mutx, enabling one-command releases that handle version bumping, binary builds for multiple platforms, GitHub releases, and Homebrew tap updates.

## Architecture

### Core Tools

- **cargo-dist**: Cross-platform binary builder that generates GitHub Actions workflows automatically
- **cargo-release**: Version management tool that bumps versions, creates tags, and triggers releases
- **git-cliff**: Changelog generator that creates entries from conventional commits
- **GitHub Actions**: CI/CD runner executing the cargo-dist generated workflow
- **GitHub Releases**: Hosts binary artifacts with automatic checksums
- **Homebrew tap** (`aaronbassett/homebrew-tap`): Automatically updated formula repository

### Build Targets

Platform support aligns with current limitations (Unix/Linux/macOS only, Windows planned for v2.0):

- `x86_64-unknown-linux-gnu` (Intel/AMD Linux)
- `aarch64-unknown-linux-gnu` (ARM64 Linux)
- `x86_64-apple-darwin` (Intel Mac)
- `aarch64-apple-darwin` (Apple Silicon)

### Release Flow

1. Developer runs `cargo release [patch|minor|major]` locally
2. git-cliff regenerates CHANGELOG.md from commits since last tag
3. cargo-release bumps version in Cargo.toml, updates Cargo.lock, commits changes
4. cargo-release creates git tag and pushes to GitHub
5. Git tag push triggers GitHub Actions workflow (generated by cargo-dist)
6. GitHub Actions builds binaries for all 4 targets using cross-compilation
7. Binaries are uploaded to GitHub Releases with checksums
8. cargo-dist automatically updates `aaronbassett/homebrew-tap` with the new formula
9. Users can immediately `brew install aaronbassett/tap/mutx`

## Configuration

### cargo-dist Configuration (Cargo.toml)

```toml
[workspace.metadata.dist]
# Build targets
targets = [
    "x86_64-unknown-linux-gnu",
    "aarch64-unknown-linux-gnu",
    "x86_64-apple-darwin",
    "aarch64-apple-darwin"
]

# Enable Homebrew installer
installers = ["homebrew"]
tap = "aaronbassett/homebrew-tap"

# CI configuration
ci = ["github"]
publish-jobs = ["homebrew"]
```

### cargo-release Configuration

Pre-release checks:
- Ensure tests pass
- Ensure code is clean (clippy, fmt)

Operations:
- Update Cargo.toml and Cargo.lock
- Run git-cliff to regenerate CHANGELOG.md
- Commit changes
- Create and push git tag
- Skip crates.io publishing (Homebrew is the distribution method)

### git-cliff Configuration (cliff.toml)

- Parse conventional commits (feat, fix, docs, etc.)
- Group by commit type (Features, Bug Fixes, Documentation)
- Filter out noise (chore commits can be hidden)
- Link to commits/PRs on GitHub
- Follow Keep a Changelog format

### GitHub Actions Workflow

Auto-generated by `cargo dist init` at `.github/workflows/release.yml`:
- Triggers on git tags matching `v*.*.*`
- Matrix builds for all 4 targets
- Artifact upload to GitHub Releases
- Homebrew tap formula update

### GitHub Secrets

Required secret: `HOMEBREW_TAP_TOKEN`
- GitHub Personal Access Token with `repo` and `workflow` permissions
- Used by cargo-dist to create releases and update homebrew-tap

## Developer Workflow

### Making a Release

```bash
# For bug fixes (1.0.0 -> 1.0.1)
cargo release patch --execute

# For new features (1.0.0 -> 1.1.0)
cargo release minor --execute

# For breaking changes (1.0.0 -> 2.0.0)
cargo release major --execute
```

### What Happens Automatically

**Local (cargo-release + git-cliff):**
1. Runs pre-release checks (tests, clippy, fmt)
2. Regenerates CHANGELOG.md from commits using git-cliff
3. Updates version in Cargo.toml (e.g., 1.0.0 â†’ 1.1.0)
4. Updates Cargo.lock
5. Commits with message like "chore: Release mutx version 1.1.0"
6. Creates git tag `v1.1.0`
7. Pushes commit and tag to GitHub

**Remote (GitHub Actions + cargo-dist):**
1. GitHub detects the `v1.1.0` tag
2. Triggers the cargo-dist workflow
3. Builds binaries on GitHub's runners (~5-10 minutes)
4. Creates GitHub Release with all 4 binaries + checksums
5. Updates `aaronbassett/homebrew-tap` with new formula pointing to the release
6. Users can install: `brew install aaronbassett/tap/mutx`

### Conventional Commits

Use standardized commit message format for git-cliff:

```
feat: add streaming mode for large files
fix: prevent lock file corruption on crash
docs: update installation instructions
chore: bump dependencies
```

Common prefixes:
- `feat`: New features
- `fix`: Bug fixes
- `docs`: Documentation changes
- `style`: Code style changes (formatting, etc.)
- `refactor`: Code refactoring
- `perf`: Performance improvements
- `test`: Test additions or changes
- `chore`: Build process, tooling, dependencies

## Testing and Validation

### Initial Setup (v1.0.0)

Since v1.0.0 is already committed but not tagged:
1. Create retrospective CHANGELOG entry using git-cliff
2. Amend or create new commit if needed
3. Create `v1.0.0` tag to trigger first automated release
4. Validate entire pipeline works before using for future releases

### Pre-release Testing

Before relying on automated releases:
- `cargo dist build` - Build binaries locally to verify configuration
- `cargo dist plan` - Show what would be released without doing it
- Draft releases - First run can create GitHub draft release to verify before publishing

### Common Failures

| Issue | Detection | Resolution |
|-------|-----------|------------|
| Build fails for a target | GitHub Actions shows red X | Fix code, delete tag, re-release |
| Homebrew tap update fails | Actions logs show auth error | Fix PAT permissions, re-run workflow |
| Binary doesn't work on platform | User report | Hotfix release (patch version) |
| git-cliff missing commits | CHANGELOG incomplete | Update cliff.toml filters |

### Rollback Strategy

If a release is broken:
1. Delete the git tag locally: `git tag -d v1.1.0`
2. Delete tag on GitHub: `git push --delete origin v1.1.0`
3. Delete the GitHub Release through web UI
4. Fix the issue
5. Re-run `cargo release` with the same version

### Monitoring

- GitHub Actions tab shows build status
- GitHub Releases shows download counts
- Homebrew analytics (if enabled) shows install counts

## First-Time Setup Checklist

1. Install tools:
   - `cargo install cargo-dist`
   - `cargo install cargo-release`
   - `cargo install git-cliff`

2. Initialize cargo-dist:
   - Run `cargo dist init`
   - Configure for 4 targets (x86_64/aarch64 Linux/macOS)
   - Enable Homebrew installer
   - Generate GitHub Actions workflow

3. Configure git-cliff:
   - Run `git cliff --init` to create `cliff.toml`
   - Customize grouping and filtering

4. Configure cargo-release:
   - Add pre-release hook to run git-cliff
   - Disable crates.io publishing
   - Enable tag pushing

5. Set up GitHub:
   - Create GitHub Personal Access Token
   - Add as `HOMEBREW_TAP_TOKEN` secret in repository settings
   - Ensure `aaronbassett/homebrew-tap` repository exists

6. Test pipeline:
   - Create v1.0.0 tag
   - Verify GitHub Actions workflow runs
   - Verify binaries are built for all targets
   - Verify GitHub Release is created
   - Verify Homebrew tap is updated
   - Test installation: `brew install aaronbassett/tap/mutx`

## Future Enhancements

- Windows support (planned for v2.0)
- Additional installers (shell script, cargo-binstall)
- Automated release notes generation with AI summaries
- Performance benchmarking in CI
- Signing binaries for additional security
